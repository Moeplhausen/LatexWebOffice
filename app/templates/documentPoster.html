{% extends "_wrapper.html" %}

<!-- Header -->
{% block header %}
<style type="text/css">
pre {outline: 1px solid #ccc; padding: 5px; margin: 5px; }
.string { color: green; }
.number { color: darkorange; }
.boolean { color: blue; }
.null { color: magenta; }
.key { color: red; }
</style>
{% endblock %}

<!-- Inhalt -->
{% block content %}
<!-- content area with login -->
<div id='inhalt'>
    <form id="poster">{% csrf_token %} Command:
        <select name="command" id="command" size="5">
        </select>
        <p id="name">Name:
            <input id="name" , name="name" type="text" value="" />
        </p>
        <p id="id">ID:
            <input id="id" , name="id" type="text" value="" />
        </p>
        <p id="folderid">Folderid:
            <input id="folderid" , name="folderid" type="text" value="" />
        </p>
        <p id='content'>Content:
            <input id="content" , name="content" type="text" value="" />
        </p>
        <p id='files'>Files:
            <input type="file" name="files" id="files" multiple>
        </p>
        <br>
        <input type="submit" value="Send" />
    </form>

    <pre id='response'>
    </pre>

    <script>
        //Die commands sortieren, sodass man sie in der liste leicht wiederfinden kann
        sortedCommandKeys = []
        for (cmd in AVAILABLE_COMMANDS) sortedCommandKeys.push(cmd);
        sortedCommandKeys.sort();
        //Jeder command wird als option eingefügt
        for (var i = 0; i < sortedCommandKeys.length; ++i) {
            cmd = sortedCommandKeys[i]
            $("#command")
                .append('<option value=' + cmd + '>' + cmd + '</option>');
        }

        //Falls ein command angeklickt werden, sollen parameter, die nicht benötigt werden, ausgeblendet werden
        $("#command")
            .change(function(key, value) {
                $("select option:selected")
                    .each(function() {
                        var str = $(this)
                            .text();
                        var paras = AVAILABLE_COMMANDS[str];
                        var inputs = $("#poster p");
                        inputs.each(function() {
                            //   this.hide()
                            $("#" + this.id)
                                .hide()

                        });
                        //Die Parameter, die benötigt werden, sollen eingeblendet werden
                        for (input in AVAILABLE_COMMANDS[str]) {
                            $("#" + AVAILABLE_COMMANDS[str][input]['para']['name'])
                                .show()
                        }

                    });

            })
            .change();




        function syntaxHighlight(json) { // http://stackoverflow.com/questions/4810841/how-can-i-pretty-print-json-using-javascript
            json = json.replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
            return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function(match) {
                var cls = 'number';
                if (/^"/.test(match)) {
                    if (/:$/.test(match)) {
                        cls = 'key';
                    } else {
                        cls = 'string';
                    }
                } else if (/true|false/.test(match)) {
                    cls = 'boolean';
                } else if (/null/.test(match)) {
                    cls = 'null';
                }
                return '<span class="' + cls + '">' + match + '</span>';
            });
        }
        $('#poster')
            .submit(function(e) {
                e.preventDefault();

                var data = new FormData(this); // <-- 'this' is your form element

                $.ajax({
                    url: '/documents/',
                    data: data,
                    cache: false,
                    contentType: false,
                    processData: false,
                    type: 'POST',
                    success: function(data, status, xhr) { //http://stackoverflow.com/questions/16086162/handle-file-download-from-ajax-post

                        // check for a filename
                        var filename = "";
                        var disposition = xhr.getResponseHeader('Content-Disposition');
                        if (disposition && disposition.indexOf('attachment') !== -1) {
                            var filenameRegex = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;
                            var matches = filenameRegex.exec(disposition);
                            if (matches != null && matches[1]) filename = matches[1].replace(/['"]/g, '');
                        }
                        var type = xhr.getResponseHeader('Content-Type');
                        var blob = new Blob([response], {
                            type: type
                        });
                        var URL = window.URL || window.webkitURL;
                        var downloadUrl = URL.createObjectURL(blob);
                        if (filename) {
                            // use HTML5 a[download] attribute to specify filename
                            var a = document.createElement("a");
                            // safari doesn't support this yet
                            if (typeof a.download === 'undefined') {
                                window.location = downloadUrl;
                            } else {
                                a.href = downloadUrl;
                                a.download = filename;
                                document.body.appendChild(a);
                                a.click();
                            }
                        } else {}

                        console.log(data)
                        $('#response')
                            .html(syntaxHighlight(JSON.stringify(data.response, null, '\t')))
                    }
                });
            });
    </script>
</div>
{% endblock %}

